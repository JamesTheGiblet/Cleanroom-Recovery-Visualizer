<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LWS - Cleanroom Recovery Visualizer</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
            /* --- Responsive Mobile Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        /* Prevent iOS text size adjust */
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        :root {
            /* LWS Branding Colors: Scientific Blue & Clean White */
            --primary: #0056b3;
            --primary-light: #4dabf7;
            --primary-dark: #003d80;
            --secondary: #20c997; /* Teal for "Clean" */
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --success: #28a745;
            --light-bg: #f1f3f5;
            --dark-text: #343a40;
            --card-bg: #ffffff;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.12);
            --radius: 8px; /* Sharper corners for "Technical" look */
            --radius-sm: 4px;
            --transition: all 0.3s ease;
        }
        
        body {
            font-family: 'Roboto', 'Segoe UI', -apple-system, sans-serif;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: var(--dark-text);
            line-height: 1.6;
            padding-bottom: 80px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 12px;
        }

        @media (max-width: 900px) {
            .container {
                max-width: 100%;
                padding: 0 4px;
            }
        }

        @media (max-width: 700px) {
            .container {
                padding: 0 2px;
            }
        }

        @media (max-width: 600px) {
            body {
                font-size: 0.98em;
                padding-bottom: 60px;
            }
            .header {
                padding: 10px 2px;
            }
            .header h1 {
                font-size: 1.05rem;
                gap: 6px;
            }
            .header .subtitle {
                font-size: 0.7rem;
            }
            .tab-nav {
                top: 56px;
            }
            .tab-btn {
                min-width: 80px;
                font-size: 0.78rem;
                padding: 10px 4px;
                gap: 2px;
            }
            .tab-btn i {
                font-size: 1rem;
            }
            .card, .chart-wrapper {
                padding: 8px;
                margin-bottom: 10px;
                border-radius: 6px;
            }
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .drink-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .btn {
                font-size: 0.85rem;
                padding: 10px 8px;
            }
            .slider-label {
                font-size: 0.85rem;
            }
            .slider-value {
                font-size: 0.8rem;
                min-width: 40px;
            }
            .timeline {
                padding-left: 12px;
            }
            .timeline-item {
                margin-bottom: 12px;
            }
            .toast {
                min-width: 180px;
                font-size: 0.8rem;
                padding: 8px 12px;
                bottom: 10px;
            }
        }

        @media (max-width: 400px) {
            .header .subtitle { display: none; }
            
            /* Even more compact metrics */
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .metric-card {
                padding: 8px;
            }
            
            .metric-value {
                font-size: 1.3rem;
            }
            
            /* Compact timeline */
            .timeline {
                padding-left: 16px;
            }
            
            .timeline-item::before {
                left: -16px;
                width: 8px;
                height: 8px;
            }
        }
        
        /* Optimize for landscape on small devices */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 8px;
                position: static;
            }
            
            .tab-nav {
                top: 0;
            }
            
            #chart {
                height: 250px;
            }
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            padding: 16px 12px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.5px;
        }
        
        .header .subtitle {
            font-size: 0.8rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Tab Navigation */
        .tab-nav {
            background: white;
            box-shadow: var(--shadow);
            position: sticky;
            top: 76px;
            z-index: 999;
            overflow-x: auto;
        }
        /* Hide scrollbar for Chrome, Safari, Opera */
        .tab-nav::-webkit-scrollbar {
            display: none;
        }
        
        .tab-buttons {
            display: flex;
            padding: 0;
            min-width: min-content;
        }
        
        .tab-btn {
            flex: 1;
            min-width: 100px;
            padding: 14px 12px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--dark-text);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }
        
        .tab-btn i { font-size: 1.2rem; }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(0, 86, 179, 0.05);
        }
        
        .tab-content {
            display: none;
            padding: 16px 0;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            border-top: 3px solid var(--primary); /* Technical Accent */
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            cursor: pointer;
        }
        
        .card-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        /* Chart Container */
        .chart-wrapper {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            border-top: 3px solid var(--primary);
            contain: layout style;
        }
        
        #chart { width: 100%; height: 350px; }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: var(--radius-sm);
            padding: 14px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Sliders */
        .slider-container { margin-bottom: 20px; }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .slider-value {
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #dee2e6;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Radio Group - ACH Settings */
        .radio-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        @media (min-width: 480px) {
            .radio-group { grid-template-columns: repeat(2, 1fr); }
        }
        
        .radio-container {
            padding: 14px;
            background: var(--light-bg);
            border: 2px solid transparent;
            border-radius: var(--radius-sm);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
        }
        
        .radio-container.selected {
            background: rgba(0, 86, 179, 0.1);
            border-color: var(--primary);
        }
        
        .radio-label { font-weight: 700; font-size: 0.95rem; color: var(--primary-dark); }
        .radio-sublabel { font-size: 0.8rem; color: #666; margin-top: 4px; }
        
        /* Contamination Presets */
        .drink-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .drink-card {
            background: var(--light-bg);
            border: 1px solid #dee2e6;
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        /* Better tap feedback */
        .drink-card:active, .tab-btn:active {
            transform: scale(0.97);
            transition: transform 0.1s ease;
        }
        
        .drink-icon { font-size: 1.8rem; margin-bottom: 8px; color: var(--primary); }
        .drink-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
        .drink-caffeine { font-size: 0.75rem; color: #666; }
        
        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-outline {
            background: white;
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        /* Timeline */
        .timeline { position: relative; padding-left: 24px; margin-top: 10px; }
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item { position: relative; margin-bottom: 20px; --event-color: var(--primary); }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 4px;
            width: 10px;
            height: 10px;
            background: var(--event-color);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px var(--event-color);
        }
        
        .timeline-time { font-weight: 700; color: var(--primary-dark); font-size: 0.85rem; }
        .timeline-content { font-size: 0.8rem; color: #555; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--dark-text);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            min-width: 300px;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Print Styles */
        .print-only { display: none; }
        @media print {
            body { background: white; padding: 0; }
            .header, .tab-nav, .btn, .toast, .slider-container, .radio-group, .drink-grid, .subtitle { display: none !important; }
            .container { max-width: 100%; margin: 0; padding: 20px; }
            .card { box-shadow: none; border: 1px solid #ddd; margin-bottom: 20px; }
            .chart-wrapper { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; }
            #dashboard { display: block !important; }
            #inputs, #config { display: none !important; }
            .print-only { display: block; text-align: center; margin-bottom: 30px; }
            .print-only h1 { color: var(--primary); margin-bottom: 5px; }
            .print-only p { color: #666; font-size: 0.9rem; }
        }
        
        /* Add hover fallbacks for touch devices */
        @media (hover: none) and (pointer: coarse) {
            .drink-card:hover { background: #e2e6ea; }
            .tab-btn:hover { background: rgba(0, 86, 179, 0.05); }
        }
        
        /* Simulation Controls */
        .sim-controls { display: flex; gap: 8px; margin-right: 12px; }
        .control-btn {
            background: white; border: 1px solid #dee2e6; border-radius: 4px;
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--dark-text); transition: var(--transition);
        }
        .control-btn:hover { background: #e9ecef; color: var(--primary); }
        .control-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Live Indicator States */
        .live-badge.paused {
            color: var(--warning); border-color: var(--warning); background: rgba(255, 193, 7, 0.1);
        }
        .live-badge.paused .live-dot { background: var(--warning); animation: none; }
        .live-badge.stopped {
            color: var(--danger); border-color: var(--danger); background: rgba(220, 53, 69, 0.1);
        }
        .live-badge.stopped .live-dot { background: var(--danger); animation: none; }

        /* Live Indicator */
        .live-badge {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
            border: 1px solid var(--success);
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 12px;
            text-transform: uppercase;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            vertical-align: middle;
            margin-left: 10px;
        }
        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            display: inline-block;
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); opacity: 1; }
            70% { box-shadow: 0 0 0 6px rgba(40, 167, 69, 0); opacity: 0.7; }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); opacity: 1; }
        }

        /* Critical Alert Flash */
        @keyframes flash-red {
            0% { background-color: rgba(220, 53, 69, 0); }
            10% { background-color: rgba(220, 53, 69, 0.4); }
            100% { background-color: rgba(220, 53, 69, 0); }
        }
        
        .flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5000; animation: flash-red 0.6s ease-out;
        }

        /* Tutorial Styles */
        .tutorial-highlight {
            position: absolute;
            z-index: 4000;
            border: 2px solid var(--warning);
            border-radius: 4px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
            pointer-events: none;
            transition: all 0.3s ease;
            display: none;
        }
        .tutorial-tooltip {
            position: absolute;
            z-index: 4001;
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 280px;
            display: none;
            transition: all 0.3s ease;
        }
        .tutorial-tooltip h3 { margin-top: 0; color: var(--primary); font-size: 1.1rem; margin-bottom: 8px; }
        .tutorial-tooltip p { font-size: 0.9rem; color: #555; margin-bottom: 15px; line-height: 1.5; }
        .tutorial-footer { display: flex; justify-content: space-between; align-items: center; }
        .tutorial-dots { display: flex; gap: 4px; }
        .tutorial-dot { width: 8px; height: 8px; background: #eee; border-radius: 50%; }
        .tutorial-dot.active { background: var(--primary); }

        /* Info Modal Styles */
        .header .info-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.1rem;
        }
        .header .info-btn:hover { background: rgba(255,255,255,0.3); }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 3000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover { color: var(--dark-text); }

        .markdown-body { line-height: 1.6; color: var(--dark-text); }
        .markdown-body h2 { margin-top: 1.5em; margin-bottom: 0.5em; color: var(--primary-dark); border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .markdown-body h3 { margin-top: 1.2em; margin-bottom: 0.5em; color: var(--primary); }
        .markdown-body ul, .markdown-body ol { margin-left: 20px; margin-bottom: 1em; }
        .markdown-body p { margin-bottom: 1em; }
        .markdown-body blockquote { border-left: 4px solid var(--warning); padding-left: 12px; color: #555; background: #fff3cd30; margin: 1em 0; }
        .markdown-body code { background: #f8f9fa; padding: 2px 4px; border-radius: 4px; font-family: monospace; color: var(--danger); }
        .markdown-body img { max-width: 100%; height: auto; }

        /* Accessibility: Keyboard Navigation */
        body.keyboard-nav :focus {
            outline: 3px solid var(--warning);
            outline-offset: 2px;
        }
        body:not(.keyboard-nav) :focus {
            outline: none;
        }
        
        /* Pro Feature Styles */
        .pro-badge { background: var(--warning); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; vertical-align: middle; margin-left: 6px; }
        .locked-btn { background: #6c757d !important; cursor: not-allowed; opacity: 0.8; }
        .blur-text { filter: blur(4px); -webkit-user-select: none; user-select: none; opacity: 0.6; }
        .radio-container.locked { opacity: 0.6; cursor: not-allowed; position: relative; }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <i class="fas fa-shield-virus"></i>
            LWS Recovery
        </h1>
        <div class="subtitle">Cleanroom Contamination Visualizer <span class="pro-badge">DEMO</span></div>
        <button class="info-btn" onclick="toggleModal(true)" aria-label="About this tool">
            <i class="fas fa-info"></i>
        </button>
    </div>
    
    <div class="tab-nav">
        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-chart-area"></i>
                <span>Monitor</span>
            </button>
            <button class="tab-btn" data-tab="inputs">
                <i class="fas fa-plus-circle"></i>
                <span>Events</span>
            </button>
            <button class="tab-btn" data-tab="config">
                <i class="fas fa-sliders-h"></i>
                <span>Config</span>
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="print-only">
            <h1>Cleanroom Recovery Report</h1>
            <p>Generated: <span id="print-timestamp"></span></p>
        </div>
        <div class="tab-content active" id="dashboard">
            <div class="chart-wrapper">
                <div id="chart" style="min-height: 350px; display: flex; align-items: center; justify-content: center;">
                    <div class="chart-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div style="margin-top: 10px; font-size: 0.9rem;">Loading visualization...</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-tachometer-alt"></i> Room Status (ISO 7)</h3>
                    <div style="display:flex; align-items:center;">
                        <div class="sim-controls">
                            <button class="control-btn" onclick="toggleSimulation()" id="btn-playpause" title="Play/Pause"><i class="fas fa-pause"></i></button>
                            <button class="control-btn" onclick="stopSimulation()" title="Stop & Reset"><i class="fas fa-stop"></i></button>
                        </div>
                        <span class="live-badge" id="sim-badge"><span class="live-dot"></span> Live</span>
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="current-load">12,500</div>
                        <div class="metric-label">Particles (0.5¬µm)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="time-to-clean">14m</div>
                        <div class="metric-label">Recovery Time</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="ach-display">20</div>
                        <div class="metric-label">Current ACH</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="status-text" style="color:var(--success)">SAFE</div>
                        <div class="metric-label">Compliance</div>
                    </div>
                </div>
            </div>
            
             <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-history"></i> Event Log</h3>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary locked-btn" onclick="showProAlert('PDF Reports')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">
                            <i class="fas fa-lock"></i> PDF
                        </button>
                        <button class="btn btn-primary locked-btn" onclick="showProAlert('CSV Export')" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">
                            <i class="fas fa-lock"></i> CSV
                        </button>
                    </div>
                </div>
                <div class="timeline" id="event-timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">System Ready</div>
                        <div class="timeline-content">No contamination events recorded.</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="inputs">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Simulate Contamination</h3>
                </div>
                <p style="margin-bottom:12px; font-size:0.9rem; color:#666;">Tap to simulate particle generation events:</p>
                <div class="drink-grid" id="contamination-presets">
                    </div>
            </div>
            <div class="card">
                 <button class="btn btn-outline" onclick="clearEvents()">
                    <i class="fas fa-trash"></i> Reset Simulation
                </button>
            </div>
        </div>
        
        <div class="tab-content" id="config">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-fan"></i> HVAC Settings</h3>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div class="slider-label">
                        <span>Air Changes per Hour (ACH)</span>
                        <div style="text-align:right">
                            <span class="slider-value" id="display-ach">20</span>
                            <div style="font-size:0.7rem; color:#666; margin-top:2px;" id="energy-cost"><i class="fas fa-lock" style="font-size:0.6rem"></i> <span class="blur-text">$0.06/hr</span></div>
                        </div>
                    </div>
                    <div class="radio-group">
                        <label class="radio-container" data-ach="10" onclick="setACH(10, event)">
                            <div class="radio-label">Eco Mode</div>
                            <div class="radio-sublabel">10 ACH (Slow Recovery)</div>
                        </label>
                        <label class="radio-container selected" data-ach="20" onclick="setACH(20, event)">
                            <div class="radio-label">Standard</div>
                            <div class="radio-sublabel">20 ACH (ISO 7/8)</div>
                        </label>
                        <label class="radio-container" data-ach="40" onclick="setACH(40, event)">
                            <div class="radio-label">High Velocity</div>
                            <div class="radio-sublabel">40 ACH (Rapid Clean)</div>
                        </label>
                        <label class="radio-container locked" onclick="showProAlert('Emergency Flush Mode')">
                            <div class="radio-label">Emergency</div>
                            <div class="radio-sublabel">60 ACH (Flush)</div>
                        </label>
                    </div>
                </div>

                <div class="slider-container">
                    <div class="slider-label">
                        <span>Room Volume (m¬≥)</span>
                        <span class="slider-value" id="display-volume">100</span>
                    </div>
                    <input type="range" id="volume" min="50" max="500" value="100" step="10">
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-ruler-combined"></i> ISO Standards</h3>
                </div>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>ISO Limit (Particles/m¬≥)</span>
                        <span class="slider-value" id="display-iso">352,000</span>
                    </div>
                    <input type="range" id="iso-limit" min="3500" max="1000000" value="352000" step="1000">
                    <p style="font-size:0.8rem; color:#666; margin-top:8px;">
                        Default is ISO Class 7 (352,000 particles ‚â• 0.5¬µm).
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification</span>
    </div>

    <!-- Tutorial Elements -->
    <div id="tutorial-highlight" class="tutorial-highlight"></div>
    <div id="tutorial-tooltip" class="tutorial-tooltip">
        <h3 id="tutorial-title"></h3>
        <p id="tutorial-text"></p>
        <div class="tutorial-footer">
            <button id="tutorial-skip" style="background:none; border:none; color:#999; font-size:0.8rem; cursor:pointer; padding:4px;">Skip</button>
            <div class="tutorial-dots" id="tutorial-dots"></div>
            <button class="btn btn-primary" id="tutorial-next" style="width:auto; padding: 6px 12px; font-size: 0.8rem;">Next</button>
        </div>
    </div>

    <!-- Readme Modal -->
    <div id="readme-modal" class="modal" onclick="if(event.target === this) toggleModal(false)">
        <div class="modal-content">
            <span class="close-modal" onclick="toggleModal(false)">&times;</span>
            <div class="markdown-body">
                <h1 style="margin-bottom:0.5em; color:var(--primary-dark);">LWS Cleanroom Recovery Visualizer</h1>
                <p>
                    <img src="https://img.shields.io/badge/version-1.1.0-blue.svg" alt="Version">
                    <img src="https://img.shields.io/badge/status-demo-orange.svg" alt="Status">
                    <img src="https://img.shields.io/badge/ISO-14644--3-compliant-green.svg" alt="Compliance">
                </p>
                <p><strong>A real-time contamination decay simulation tool designed for Lighthouse Worldwide Solutions.</strong></p>
                <p>This Progressive Web Application (PWA) models cleanroom recovery performance based on Air Changes per Hour (ACH) and specific contamination events. It visualizes the exponential decay of airborne particulates to predict exactly when a facility returns to <strong>ISO Class 7</strong> compliance.</p>
                <blockquote>
                    <p><strong>Note:</strong> This deployment is configured in <strong>DEMO MODE</strong>. Enterprise features (PDF Reporting, CSV Export, Cost Analysis) are visible but locked to demonstrate the upgrade path.</p>
                </blockquote>
                
                <h2>üéØ The Problem</h2>
                <p>Facility managers often rely on static calculations to estimate room recovery times. When a contamination event occurs (e.g., a spill or gowning breach), they need to know:</p>
                <ol>
                    <li><strong>How bad is the spike?</strong></li>
                    <li><strong>Given our current HVAC settings (ACH), how long until we are safe?</strong></li>
                </ol>

                <h2>‚ö° The Solution</h2>
                <p>This tool uses <strong>First-Order Decay Kinetics</strong> (identical to pharmacokinetic clearance models) to visualize air scrubbing in real-time.</p>
                <h3>Key Features</h3>
                <ul>
                    <li><strong>Dynamic Simulation:</strong> Model complex scenarios (e.g., "Door Open" followed by "Spill").</li>
                    <li><strong>HVAC Tuning:</strong> Adjust Air Changes per Hour (10-60 ACH) to see the impact on recovery time.</li>
                    <li><strong>ISO Compliance:</strong> Visual thresholds for ISO Class 7/8 limits.</li>
                    <li><strong>Zero-Latency Graphing:</strong> Powered by Plotly.js for millisecond-level rendering updates.</li>
                    <li><strong>Mobile-First Architecture:</strong> Touch-optimized for tablets and mobile devices (iOS/Android).</li>
                    <li><strong>State Persistence:</strong> Automatically saves configuration and event history to local storage.</li>
                </ul>

                <h2>üìê The Math (Scientific Basis)</h2>
                <p>The logic engine calculates particulate reduction using the standard Cleanroom Recovery Formula:</p>
                <div style="background:#f8f9fa; padding:12px; border-radius:4px; text-align:center; margin:10px 0; font-family:serif; font-style:italic; font-size:1.1rem; border:1px solid #dee2e6;">
                    C<sub>t</sub> = C<sub>initial</sub> √ó e<sup>-(Q/V)t</sup>
                </div>
                <p>Where:</p>
                <ul>
                    <li><strong>C<sub>t</sub></strong>: Concentration at time <em>t</em></li>
                    <li><strong>Q</strong>: Airflow rate (m¬≥/h)</li>
                    <li><strong>V</strong>: Room Volume (m¬≥)</li>
                    <li><strong>t</strong>: Time elapsed</li>
                </ul>

                <h2>üöÄ Quick Start</h2>
                <p>This prototype is built as a <strong>Zero-Dependency Single Page Application (SPA)</strong>. It requires no build step, no backend, and no installation.</p>
                
                <h3>Deployment</h3>
                <p>Because the architecture is static HTML/JS, it can be deployed instantly to:</p>
                <ul>
                    <li>GitHub Pages</li>
                    <li>Netlify / Vercel</li>
                    <li>Internal LWS Intranet (SharePoint/Confluence)</li>
                </ul>

                <h2>üõ† Tech Stack</h2>
                <ul>
                    <li><strong>Core:</strong> Vanilla JavaScript (ES6+) for maximum performance and compatibility.</li>
                    <li><strong>Visualization:</strong> Plotly.js (via CDN) for scientific-grade charting.</li>
                </ul>
                
                <button class="btn btn-outline" onclick="startTutorial(); toggleModal(false)" style="margin-top:20px;">
                    <i class="fas fa-play-circle"></i> Replay Tutorial
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION & STATE
        // ==========================================
        
        const events = [
            { name: 'Door Opened', icon: 'fa-door-open', particles: 1000000, desc: '1 min duration', color: '#17a2b8' },
            { name: 'Person Entering', icon: 'fa-user', particles: 5000000, desc: 'Gowning protocol', color: '#0056b3' },
            { name: 'Equipment Move', icon: 'fa-box', particles: 15000000, desc: 'Cart rolling', color: '#ffc107' },
            { name: 'Spill / Cleaning', icon: 'fa-broom', particles: 25000000, desc: 'Aerosol generation', color: '#fd7e14' },
            { name: 'Process Failure', icon: 'fa-exclamation-circle', particles: 50000000, desc: 'Major release', color: '#dc3545' },
            { name: 'Shift Change', icon: 'fa-users', particles: 10000000, desc: 'Multiple entries', color: '#6610f2' }
        ];

        let state = {
            events: [],
            ach: parseInt(localStorage.getItem('cr_ach')) || 20,
            volume: parseInt(localStorage.getItem('cr_volume')) || 100,
            isoLimit: parseInt(localStorage.getItem('cr_iso')) || 352000, // ISO Class 7
            baseline: 1000, // Background particles
            // Simulation State
            timeOffset: parseInt(localStorage.getItem('cr_offset')) || 0,
            isPaused: localStorage.getItem('cr_paused') === 'true',
            lastPauseTime: parseInt(localStorage.getItem('cr_last_pause')) || Date.now()
        };

        let simulationInterval;

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            initTabs();
            initPresets();
            initControls();
            initTouch();
            initKeyboard();
            updateVis();
            checkTutorial();
            
            // Start real-time simulation loop if not paused
            if (!state.isPaused) {
                startInterval();
            }
        });

        function initData() {
            // Restore full event history from crash/refresh
            const saved = localStorage.getItem('cr_events');
            if (saved) {
                state.events = JSON.parse(saved).map(ev => ({
                    ...ev,
                    time: new Date(ev.time) // Re-hydrate Date objects
                }));
                updateTimeline();
            }
        }

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                    if(btn.dataset.tab === 'dashboard') updateVis(); // Redraw chart
                });
            });
        }

        function initPresets() {
            const grid = document.getElementById('contamination-presets');
            events.forEach(ev => {
                const card = document.createElement('div');
                card.className = 'drink-card';
                
                // Smart formatting for large numbers (k vs M)
                let qtyDisplay = '';
                if (ev.particles >= 1000000) {
                    qtyDisplay = (ev.particles / 1000000).toFixed(1).replace('.0','') + 'M';
                } else {
                    qtyDisplay = (ev.particles / 1000).toFixed(0) + 'k';
                }

                card.innerHTML = `
                    <div class="drink-icon"><i class="fas ${ev.icon}"></i></div>
                    <div class="drink-name">${ev.name}</div>
                    <div class="drink-caffeine">+${qtyDisplay} particles</div>
                `;
                card.onclick = () => addEvent(ev);
                grid.appendChild(card);
            });
        }

        function initTouch() {
            // Add touch event listeners for better feedback
            document.querySelectorAll('.drink-card').forEach(card => {
                card.addEventListener('touchstart', function() {
                    this.style.opacity = '0.7';
                });
                
                card.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });

            // Prevent zoom on slider interaction
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.style.touchAction = 'none';
            });
        }

        function initKeyboard() {
            // Add keyboard support for mobile users with external keyboards
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    document.body.classList.add('keyboard-nav');
                }
            });
            document.addEventListener('mousedown', () => {
                document.body.classList.remove('keyboard-nav');
            });
        }

        function initControls() {
            // Volume Slider
            const volSlider = document.getElementById('volume');
            volSlider.value = state.volume;
            document.getElementById('display-volume').textContent = state.volume;
            
            volSlider.addEventListener('input', (e) => {
                state.volume = parseInt(e.target.value);
                localStorage.setItem('cr_volume', state.volume);
                document.getElementById('display-volume').textContent = state.volume;
                updateVis();
            });

            // ISO Slider
            const isoSlider = document.getElementById('iso-limit');
            isoSlider.value = state.isoLimit;
            document.getElementById('display-iso').textContent = state.isoLimit.toLocaleString();
            
            isoSlider.addEventListener('input', (e) => {
                state.isoLimit = parseInt(e.target.value);
                localStorage.setItem('cr_iso', state.isoLimit);
                document.getElementById('display-iso').textContent = state.isoLimit.toLocaleString();
                updateVis();
            });
            
            // ACH Radio Init
            document.getElementById('display-ach').textContent = state.ach;
            document.querySelectorAll('.radio-container').forEach(el => {
                el.classList.toggle('selected', parseInt(el.dataset.ach) === state.ach);
            });
        }

        function setACH(val, evt) {
            state.ach = val;
            localStorage.setItem('cr_ach', val);
            document.getElementById('display-ach').textContent = val;
            
            // Visual toggle update
            document.querySelectorAll('.radio-container').forEach(el => el.classList.remove('selected'));
            evt.currentTarget.classList.add('selected');
            
            showToast(`HVAC set to ${val} Air Changes/Hour`);
            updateVis();
        }

        // ==========================================
        // SIMULATION CONTROL
        // ==========================================
        function startInterval() {
            if (simulationInterval) clearInterval(simulationInterval);
            simulationInterval = setInterval(updateVis, 1000);
        }

        function getSimulationTime() {
            if (state.isPaused) {
                return new Date(state.lastPauseTime - state.timeOffset);
            }
            return new Date(Date.now() - state.timeOffset);
        }

        function toggleSimulation() {
            if (state.isPaused) {
                // Resume
                const now = Date.now();
                const pausedDuration = now - state.lastPauseTime;
                state.timeOffset += pausedDuration;
                state.isPaused = false;
                startInterval();
            } else {
                // Pause
                state.isPaused = true;
                state.lastPauseTime = Date.now();
                clearInterval(simulationInterval);
            }
            saveState();
            updateVis();
        }

        function stopSimulation() {
            state.isPaused = true;
            state.lastPauseTime = Date.now();
            state.timeOffset = 0;
            state.events = []; // Clear events
            clearInterval(simulationInterval);
            saveState();
            saveEvents();
            showToast('Simulation stopped and reset');
            updateVis();
        }

        function saveState() {
            localStorage.setItem('cr_offset', state.timeOffset);
            localStorage.setItem('cr_paused', state.isPaused);
            localStorage.setItem('cr_last_pause', state.lastPauseTime);
        }

        // ==========================================
        // LOGIC ENGINE (The "Decay" Math)
        // ==========================================
        function addEvent(preset) {
            state.events.push({
                ...preset,
                time: getSimulationTime(),
                id: Date.now()
            });
            saveEvents();
            
            // Trigger Red Flash
            const flash = document.createElement('div');
            flash.className = 'flash-overlay';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 600);
            
            showToast(`Event: ${preset.name} recorded`, 'warning');
            updateVis();
            updateTimeline();
        }

        function clearEvents() {
            state.events = [];
            saveEvents();
            showToast('All contamination events cleared');
            updateVis();
            updateTimeline();
        }

        function showProAlert(feature) {
            showToast(`Upgrade to Pro to use ${feature}`, 'danger');
        }

        function saveEvents() {
            localStorage.setItem('cr_events', JSON.stringify(state.events));
        }

        function exportCSV() {
            const data = calculateCurve();
            let csvContent = "data:text/csv;charset=utf-8,Time (min),Particles\n";
            data.x.forEach((t, i) => {
                csvContent += `${t},${data.y[i]}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "cleanroom_recovery_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function generatePDF() {
            // Switch to dashboard to ensure content is rendered
            const dashboardBtn = document.querySelector('[data-tab="dashboard"]');
            if (!dashboardBtn.classList.contains('active')) dashboardBtn.click();
            
            document.getElementById('print-timestamp').textContent = new Date().toLocaleString();
            
            setTimeout(() => window.print(), 500);
        }

        function calculateCurve() {
            // Simulation parameters
            const duration = 60; // Minutes to project
            const timeStep = 1; // Minute intervals
            const now = getSimulationTime();
            
            let x = []; // Time (min)
            let y = []; // Particle Count
            
            // 1. Calculate Recovery Rate (Decay Constant)
            // Formula: C = C0 * e^(-Qt/V)  -> Decay constant k = ACH / 60
            const decayConstant = state.ach / 60; 

            for (let t = 0; t <= duration; t++) {
                // Calculate current simulation time
                const simTime = new Date(now.getTime() + t * 60000);
                let currentParticles = state.baseline;

                // Sum up residual particles from all past events
                state.events.forEach(ev => {
                    const minutesSinceEvent = (simTime - ev.time) / 60000;
                    
                    if (minutesSinceEvent >= 0) {
                        // Standard exponential decay: N(t) = N0 * e^(-kt)
                        // Calculate concentration: C(t) = (N0/V) * e^(-kt)
                        currentParticles += (ev.particles / state.volume) * Math.exp(-decayConstant * minutesSinceEvent);
                    }
                });

                x.push(t);
                y.push(Math.round(currentParticles));
            }

            return { x, y, currentVal: y[0] };
        }

        // ==========================================
        // VISUALIZATION
        // ==========================================
        function updateVis() {
            // ...existing code...
            const data = calculateCurve();

            // Overlay ACH and ISO limit as chart annotations (top right)
            const overlayAnnotations = [
                {
                    x: 1,
                    y: Math.max(...data.y) * 1.08,
                    xref: 'paper',
                    yref: 'y',
                    text: `ACH: <b>${state.ach}</b>`,
                    showarrow: false,
                    font: { color: '#0056b3', size: 13 },
                    align: 'right',
                    bgcolor: '#e9ecef',
                    bordercolor: '#0056b3',
                    borderpad: 4,
                    opacity: 0.9
                },
                {
                    x: 1,
                    y: state.isoLimit,
                    xref: 'paper',
                    yref: 'y',
                    text: `ISO Limit: <b>${state.isoLimit.toLocaleString()}</b>`,
                    showarrow: false,
                    font: { color: '#dc3545', size: 13 },
                    align: 'right',
                    bgcolor: '#fff',
                    bordercolor: '#dc3545',
                    borderpad: 4,
                    opacity: 0.9
                }
            ];
            // Optimization: Only render if dashboard is visible to save battery/CPU
            // if (!document.getElementById('dashboard').classList.contains('active')) return;

            // FIX: Remove loading state styles (flexbox) which break Plotly rendering
            const chartEl = document.getElementById('chart');
            if (chartEl.style.display === 'flex') {
                chartEl.style.display = 'block';
                chartEl.innerHTML = ''; // Clear loading spinner
            }
            
            // Update Metrics
            document.getElementById('current-load').textContent = data.currentVal.toLocaleString();
            document.getElementById('ach-display').textContent = state.ach;
            
            // Update Cost Estimate (Simple model: Volume * ACH * EfficiencyFactor * CostPerKWh)
            // LOCKED IN DEMO MODE
            
            // Calculate Recovery Time (Time to return to ISO limit)
            let recoveryTime = 0;
            if (data.currentVal > state.isoLimit) {
                // Find first point where y < limit
                const index = data.y.findIndex(val => val < state.isoLimit);
                recoveryTime = index === -1 ? '>60' : index;
            }
            document.getElementById('time-to-clean').textContent = recoveryTime + "m";
            
            // Status Text
            const statusEl = document.getElementById('status-text');
            if (data.currentVal > state.isoLimit) {
                statusEl.textContent = "CONTAMINATED";
                statusEl.style.color = "var(--danger)";
            } else {
                statusEl.textContent = "COMPLIANT";
                statusEl.style.color = "var(--success)";
            }

            // Update Controls UI
            const btnPlay = document.getElementById('btn-playpause');
            const badge = document.getElementById('sim-badge');
            
            if (state.isPaused) {
                btnPlay.innerHTML = '<i class="fas fa-play"></i>';
                if (state.events.length === 0 && state.timeOffset === 0) {
                     badge.className = 'live-badge stopped';
                     badge.innerHTML = '<span class="live-dot"></span> Stopped';
                } else {
                     badge.className = 'live-badge paused';
                     badge.innerHTML = '<span class="live-dot"></span> Paused';
                }
            } else {
                btnPlay.innerHTML = '<i class="fas fa-pause"></i>';
                badge.className = 'live-badge';
                badge.innerHTML = '<span class="live-dot"></span> Live';
            }

            // Draw Chart
            const trace1 = {
                x: data.x,
                y: data.y,
                type: 'scatter',
                mode: 'lines',
                name: 'Particles',
                line: { color: '#0056b3', width: 3 },
                fill: 'tozeroy',
                fillcolor: 'rgba(0, 86, 179, 0.1)'
            };

            const trace2 = {
                x: [0, 60],
                y: [state.isoLimit, state.isoLimit],
                mode: 'lines',
                name: 'ISO Limit',
                line: { color: '#dc3545', width: 2, dash: 'dash' }
            };

            // Add vertical event markers (shapes) for each contamination event
            const eventMarkers = (state.events || []).map(ev => {
                // Calculate minutes from now for the event
                const now = getSimulationTime();
                const minutesFromNow = Math.round((ev.time - now) / 60000);
                if (minutesFromNow < 0 || minutesFromNow > 60) return null; // Only show markers in visible range
                return {
                    type: 'line',
                    x0: minutesFromNow,
                    x1: minutesFromNow,
                    y0: 0,
                    y1: Math.max(Math.max(...data.y) * 1.1, state.isoLimit * 1.1),
                    line: {
                        color: ev.color || '#17a2b8',
                        width: 2,
                        dash: 'dot'
                    },
                    opacity: 0.8
                };
            }).filter(Boolean);

            // Add event labels as annotations
            const eventAnnotations = (state.events || []).map(ev => {
                const now = getSimulationTime();
                const minutesFromNow = Math.round((ev.time - now) / 60000);
                if (minutesFromNow < 0 || minutesFromNow > 60) return null;
                return {
                    x: minutesFromNow,
                    y: Math.max(...data.y) * 1.05,
                    xref: 'x',
                    yref: 'y',
                    text: ev.name,
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -30,
                    font: { color: ev.color || '#17a2b8', size: 11 },
                    bgcolor: '#fff',
                    bordercolor: ev.color || '#17a2b8',
                    borderpad: 2
                };
            }).filter(Boolean);

            // Shade unsafe (above ISO limit) and safe (below ISO limit) zones
            const yMax = Math.max(Math.max(...data.y) * 1.1, state.isoLimit * 1.1);
            const zoneShapes = [
                // Unsafe zone (red, above ISO limit)
                {
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    x1: 1,
                    y0: state.isoLimit,
                    y1: yMax,
                    fillcolor: 'rgba(220,53,69,0.08)', // red
                    line: { width: 0 },
                    layer: 'below'
                },
                // Safe zone (green, below ISO limit)
                {
                    type: 'rect',
                    xref: 'paper',
                    yref: 'y',
                    x0: 0,
                    x1: 1,
                    y0: 0,
                    y1: state.isoLimit,
                    fillcolor: 'rgba(40,167,69,0.06)', // green
                    line: { width: 0 },
                    layer: 'below'
                }
            ];

            // Find recovery time index (when particle count drops below ISO limit)
            let recoveryIndex = data.y.findIndex(val => val < state.isoLimit);
            let recoveryAnnotation = null;
            if (recoveryIndex !== -1 && recoveryIndex > 0) {
                recoveryAnnotation = {
                    x: data.x[recoveryIndex],
                    y: data.y[recoveryIndex],
                    xref: 'x',
                    yref: 'y',
                    text: `Recovery\n${data.x[recoveryIndex]} min`,
                    showarrow: true,
                    arrowhead: 4,
                    ax: 0,
                    ay: -40,
                    font: { color: '#28a745', size: 12, family: 'Roboto, Segoe UI, sans-serif' },
                    bgcolor: '#fff',
                    bordercolor: '#28a745',
                    borderpad: 3
                };
            }

            const layout = {
                title: false,
                xaxis: { title: 'Minutes from Now', gridcolor: '#e9ecef' },
                yaxis: { 
                    title: 'Particle Count', 
                    gridcolor: '#e9ecef', 
                    range: [0, yMax]
                },
                margin: { l: 50, r: 20, t: 20, b: 40 },
                showlegend: true,
                legend: { orientation: 'h', y: 1.1 },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                shapes: [...zoneShapes, ...eventMarkers],
                annotations: recoveryAnnotation ? [...eventAnnotations, recoveryAnnotation, ...overlayAnnotations] : [...eventAnnotations, ...overlayAnnotations]
            };

            Plotly.react('chart', [trace1, trace2], layout, {responsive: true, displayModeBar: false});
        }

        function updateTimeline() {
            const container = document.getElementById('event-timeline');
            if (state.events.length === 0) {
                container.innerHTML = `<div class="timeline-item"><div class="timeline-time">System Ready</div><div class="timeline-content">No events.</div></div>`;
                return;
            }

            // Enhanced event table
            let table = `<table style="width:100%;border-collapse:collapse;font-size:0.98em;margin-bottom:8px;">
                <thead><tr style="background:#f8f9fa;"><th style='padding:4px 8px;border-bottom:1px solid #ccc;'>Time</th><th style='padding:4px 8px;border-bottom:1px solid #ccc;'>Event</th><th style='padding:4px 8px;border-bottom:1px solid #ccc;'>Particles</th><th style='padding:4px 8px;border-bottom:1px solid #ccc;'>Description</th></tr></thead><tbody>`;
            state.events.slice().reverse().forEach(ev => {
                table += `<tr style='border-bottom:1px solid #eee;'>
                    <td style='padding:4px 8px;color:#555;'>${ev.time.toLocaleTimeString()}</td>
                    <td style='padding:4px 8px;'><span style='display:inline-block;width:10px;height:10px;border-radius:50%;background:${ev.color || '#17a2b8'};margin-right:6px;vertical-align:middle;'></span>${ev.name}</td>
                    <td style='padding:4px 8px;'>+${(ev.particles/1000).toFixed(0)}k</td>
                    <td style='padding:4px 8px;'>${ev.desc || ''}</td>
                </tr>`;
            });
            table += `</tbody></table>`;
            container.innerHTML = table;
        }

        function showToast(msg, type='info') {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.style.background = type === 'danger' ? 'var(--danger)' : 'var(--dark-text)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleModal(show) {
            const modal = document.getElementById('readme-modal');
            modal.style.display = show ? 'block' : 'none';
        }

        // ==========================================
        // TUTORIAL MODE
        // ==========================================
        let currentStep = 0;
        const tutorialSteps = [
            {
                target: null,
                title: "Welcome to LWS Recovery",
                text: "This tool simulates cleanroom contamination recovery. Let's take a quick tour of the features."
            },
            {
                target: '[data-tab="dashboard"]',
                title: "Real-time Monitor",
                text: "View live particle counts, recovery time, and ISO compliance status in real-time.",
                action: () => document.querySelector('[data-tab="dashboard"]').click()
            },
            {
                target: '[data-tab="inputs"]',
                title: "Simulate Events",
                text: "Trigger contamination events like 'Door Open' or 'Spills' to see how the room reacts.",
                action: () => document.querySelector('[data-tab="inputs"]').click()
            },
            {
                target: '[data-tab="config"]',
                title: "HVAC Controls",
                text: "Adjust Air Changes per Hour (ACH) and Room Volume to optimize recovery time.",
                action: () => document.querySelector('[data-tab="config"]').click()
            }
        ];

        function checkTutorial() {
            if (!localStorage.getItem('tutorial_shown')) {
                setTimeout(startTutorial, 1000); // Delay slightly for load
            }
        }

        function startTutorial() {
            currentStep = 0;
            showStep(0);
            localStorage.setItem('tutorial_shown', 'true');
        }

        function showStep(index) {
            const step = tutorialSteps[index];
            const highlight = document.getElementById('tutorial-highlight');
            const tooltip = document.getElementById('tutorial-tooltip');
            
            if (step.action) step.action();

            // Update Text
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;
            document.getElementById('tutorial-next').textContent = index === tutorialSteps.length - 1 ? 'Finish' : 'Next';
            
            // Update Dots
            const dotsContainer = document.getElementById('tutorial-dots');
            dotsContainer.innerHTML = tutorialSteps.map((_, i) => 
                `<div class="tutorial-dot ${i === index ? 'active' : ''}"></div>`
            ).join('');

            // Position Elements
            if (step.target) {
                const targetEl = document.querySelector(step.target);
                const rect = targetEl.getBoundingClientRect();
                const scrollY = window.scrollY;
                
                highlight.style.display = 'block';
                highlight.style.width = rect.width + 'px';
                highlight.style.height = rect.height + 'px';
                highlight.style.top = (rect.top + scrollY) + 'px';
                highlight.style.left = rect.left + 'px';
                
                tooltip.style.display = 'block';
                tooltip.style.transform = 'none';
                tooltip.style.top = (rect.bottom + scrollY + 15) + 'px';
                tooltip.style.left = (rect.left + (rect.width/2) - 140) + 'px'; // Center tooltip
                
                // Ensure tooltip stays on screen
                if (parseInt(tooltip.style.left) < 10) tooltip.style.left = '10px';
            } else {
                // Center for welcome step
                highlight.style.display = 'none';
                tooltip.style.display = 'block';
                tooltip.style.top = '50%';
                tooltip.style.left = '50%';
                tooltip.style.transform = 'translate(-50%, -50%)';
            }
        }

        document.getElementById('tutorial-next').addEventListener('click', () => {
            currentStep++;
            if (currentStep < tutorialSteps.length) {
                showStep(currentStep);
            } else {
                document.getElementById('tutorial-highlight').style.display = 'none';
                document.getElementById('tutorial-tooltip').style.display = 'none';
                // Return to dashboard
                document.querySelector('[data-tab="dashboard"]').click();
            }
        });

        document.getElementById('tutorial-skip').addEventListener('click', () => {
            document.getElementById('tutorial-highlight').style.display = 'none';
            document.getElementById('tutorial-tooltip').style.display = 'none';
        });
    </script>
</body>
</html>
